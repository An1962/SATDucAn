<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SAT Digital Practice - SAT THỦ KHOA ĐỨC AN</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Desmos API -->
    <script src="https://www.desmos.com/api/v1.9/calculator.js?apiKey=dcb31709b452b1cf9dc26972add0fda6"></script>
    <!-- MathJax -->
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] },
            svg: { fontCache: 'global' }, startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --brand-blue: #004488;
            --brand-dark: #003366;
            --brand-gold: #FFD700;
            --bb-bg-light: #f8fafc;
            --bb-border: #e5e7eb;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bb-bg-light); overflow: hidden; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        
        /* --- SMART FONT FIX --- */
        /* 1. Thiết lập font mặc định cho vùng chứa */
        .font-sat, #stimulus-area, #question-text-area, .editor-content { 
            font-family: 'Minion Pro', 'Crimson Text', 'Times New Roman', serif; 
        }
        
        /* 2. Chỉ ép font cho các thẻ VĂN BẢN để đè style copy-paste, TRÁNH các thẻ MathJax (mjx-*) */
        :is(.font-sat, #stimulus-area, #question-text-area, .editor-content) :is(p, span, div, a, li, h1, h2, h3, h4, h5, h6, b, strong, i, em, u, s, strike, mark, blockquote) {
            font-family: 'Minion Pro', 'Crimson Text', 'Times New Roman', serif !important; 
        }
        
        .no-select { user-select: none; }
        
        /* --- VIEW SWITCHING --- */
        #teacher-view { display: none; height: 100vh; overflow-y: auto; }
        .view-section { display: none; height: 100vh; flex-direction: column; }
        body.mode-teacher #teacher-view { display: block !important; }
        .view-section.view-active { display: flex !important; }

        /* Animation */
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Bluebook Dashed Line */
        .bluebook-dash {
            background-image: linear-gradient(to right, rgba(255,255,255,0.5) 50%, transparent 50%), 
                              linear-gradient(to right, #FFD700 50%, transparent 50%), 
                              linear-gradient(to right, #60a5fa 50%, transparent 50%);
            background-size: 20px 2px;
            background-repeat: repeat-x;
            background-position: 0 bottom;
            height: 2px;
            width: 100%;
            opacity: 0.6;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Option Styling */
        .sat-option {
            border: 1.5px solid #000;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 8px;
            cursor: pointer; 
            transition: background-color 0.1s; 
            display: flex; 
            align-items: flex-start; 
            background: white;
        }
        .sat-option:hover { background-color: #f3f4f6; }
        .sat-option.selected { 
            background-color: #e3f2fd;
            border-color: #0077c8; 
            outline: 2px solid #0077c8; 
            outline-offset: 1px;
            z-index: 10; 
        }
        .sat-option.struck { opacity: 0.5; background-color: #f9fafb; text-decoration: line-through; border-color: #d1d5db; }
        
        .sat-circle {
            min-width: 24px; height: 24px; border-radius: 50%; border: 1.5px solid #000; margin-right: 10px;
            display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px; flex-shrink: 0; 
            background: white; color: #000; font-family: 'Inter', sans-serif !important;
        }
        .sat-option.selected .sat-circle { background-color: #000; color: white; border-color: #000; }

        .strike-btn { margin-left: auto; color: #9ca3af; font-size: 9px; font-weight: 700; padding: 2px 4px; border-radius: 3px; text-decoration: line-through; opacity: 0; font-family: 'Inter', sans-serif !important; }
        .sat-option:hover .strike-btn { opacity: 1; }

        /* Review Colors */
        .sat-option.correct-answer { border-color: #10b981; background-color: #ecfdf5; box-shadow: 0 0 0 2px #10b981; }
        .sat-option.wrong-answer { border-color: #ef4444; background-color: #fef2f2; box-shadow: 0 0 0 2px #ef4444; }

        /* Tools */
        .tool-modal { position: absolute; top: 100px; left: 100px; background: rgba(255,255,255,0.98); border: 1px solid #cbd5e1; box-shadow: 0 20px 30px rgba(0,0,0,0.15); z-index: 50; display: none; border-radius: 12px; overflow: hidden; resize: both; backdrop-filter: blur(8px); }
        .tool-header { background: #f8fafc; padding: 8px 12px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; cursor: move; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #475569; height: 36px; font-family: 'Inter', sans-serif !important; }
        
        .nav-modal { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 640px; background: white; border: 1px solid #cbd5e1; border-radius: 12px; box-shadow: 0 -10px 30px rgba(0,0,0,0.15); z-index: 60; display: none; padding: 20px; animation: slideUp 0.2s; }
        @keyframes slideUp { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        .nav-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto; }
        .nav-item { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border: 1px solid #cbd5e1; border-radius: 4px; font-weight: 600; font-size: 13px; cursor: pointer; position: relative; background: white; color: #334155; font-family: 'Inter', sans-serif !important; }
        .nav-item:hover { background: #f1f5f9; }
        .nav-item.current { border: 2px dashed var(--brand-blue); color: var(--brand-blue); }
        .nav-item.answered { background-color: var(--brand-blue); color: white; border-color: var(--brand-blue); }
        .nav-item .nav-flag { position: absolute; top: -4px; right: -4px; color: #ef4444; font-size: 10px; background: white; border-radius: 50%; width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 2px rgba(0,0,0,0.2); border: 1px solid #fecaca; }

        /* Annotate */
        .annotate-active { background-color: rgba(255,255,255,0.2) !important; border: 1px solid rgba(255,255,255,0.5) !important; color: white !important; }
        .cursor-annotate-mode .font-sat { cursor: text; }
        ::selection { background: #bae6fd; }
        span[style*="background-color"] { cursor: pointer; border-bottom: 2px solid #fcd34d; }

        /* Typography - ULTRA COMPACT */
        .line-numbers { position: relative; padding-left: 24px; }
        .line-numbers::before {
            content: "5\A 10\A 15\A 20\A 25\A 30\A 35\A 40"; 
            white-space: pre; 
            position: absolute; 
            left: -8px; 
            top: 3.8em; 
            font-family: 'Inter', sans-serif !important; 
            color: #94a3b8; 
            font-size: 9px; 
            line-height: 6.3em;
            text-align: right; 
            width: 24px; 
            pointer-events: none;
        }
        
        .student-content {
            font-size: 1.05rem !important; 
            line-height: 1.15 !important; 
        }
        
        .student-content p { margin-bottom: 0.5em; } 

        .editor-content img, .student-content img { max-width: 100%; height: auto; display: block; margin: 8px auto; border-radius: 4px; }
        [contenteditable]:empty:before { content: attr(placeholder); color: #94a3b8; font-family: 'Inter', sans-serif; }
        .directions-box { position: absolute; top: 110%; left: 0; width: 450px; background: white; border: 1px solid #cbd5e1; border-radius: 8px; padding: 24px; z-index: 60; display: none; font-size: 14px; line-height: 1.6; box-shadow: 0 10px 25px rgba(0,0,0,0.1); color: #333; font-family: 'Inter', sans-serif !important; }
        .brand-gradient { background: linear-gradient(135deg, #004488 0%, #003366 100%); }

        /* Watermark */
        .watermark-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0; display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .watermark-img { max-width: 60%; max-height: 60%; opacity: 0.08; filter: grayscale(100%); }
        
        /* Explanation Box */
        .explanation-box { border: 1px solid #cbd5e1; border-radius: 8px; background-color: #f8fafc; padding: 12px; margin-top: 12px; font-size: 0.95rem; color: #334155; }
    </style>
</head>
<body class="mode-teacher bg-slate-50">

    <!-- TEACHER VIEW -->
    <div id="teacher-view" class="bg-slate-50 min-h-screen font-sans pb-10">
        <header class="brand-gradient text-white shadow-lg border-b-4 border-[#FFD700] sticky top-0 z-50">
            <div class="max-w-full px-6 py-3 flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <img src="https://scontent.fhan19-1.fna.fbcdn.net/v/t39.30808-6/451857108_122097042800425386_7602682011904409290_n.png?_nc_cat=105&ccb=1-7&_nc_sid=6ee11a&_nc_eui2=AeF5KI_9YQ5D-akv4pn95ai5qZLgHr4cJYSpkuAevhwlhJcbLURmaydM6uCuaMFsO0r71uvEkcB5K3qzZJUGyQ-W&_nc_ohc=jh5DGil1sVoQ7kNvwHeq4Gy&_nc_oc=AdliAeHQtcyTo_WnU8DsNytQi6TgoV5qecCfqWz3qnP5ptMUPmnKSEyvJlDwPRJNbTI&_nc_zt=23&_nc_ht=scontent.fhan19-1.fna&_nc_gid=mWvYiwDI82jFu9mMJf0d_A&oh=00_Afg3GkZGL-wffds_Vs7bra1y1EchAvJzZwt3UCai0wrnpw&oe=692EDD83" 
                         class="h-10 w-10 rounded-full border-2 border-white/30 bg-white object-cover" alt="Logo">
                    <div>
                        <h1 class="text-lg font-black uppercase leading-tight">SAT Thủ Khoa <span class="text-[#FFD700]">Đức An</span></h1>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
                    <button onclick="document.getElementById('import-file').click()" class="px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded text-xs font-bold transition flex items-center gap-2 border border-white/20"><i class="fa-solid fa-file-import"></i> Import</button>
                    <button onclick="exportData()" class="px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded text-xs font-bold transition flex items-center gap-2 border border-white/20"><i class="fa-solid fa-file-export"></i> Export</button>
                    <button onclick="clearAllData()" class="px-3 py-1.5 bg-red-500/20 hover:bg-red-500/40 rounded text-xs font-bold transition text-red-100 border border-red-400/30"><i class="fa-solid fa-trash"></i> Reset</button>
                    <button onclick="startTest()" class="bg-[#FFD700] hover:bg-[#FDB913] text-[#003366] px-5 py-1.5 rounded font-black shadow-lg transition transform active:scale-95 text-xs uppercase tracking-wide flex items-center gap-2 animate-glow">
                        <i class="fa-solid fa-play"></i> BẮT ĐẦU THI
                    </button>
                </div>
            </div>
        </header>

        <div class="max-w-[1600px] mx-auto p-4 md:p-6">
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden flex flex-col lg:flex-row lg:h-[85vh] h-auto">
                <!-- Editor Pane -->
                <div class="w-full lg:w-8/12 p-6 bg-slate-50 border-r border-slate-200 lg:overflow-y-auto custom-scroll">
                     <div class="mb-4 grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Cấu hình Môn thi</label>
                            <select id="section-config" class="w-full p-2 border border-slate-300 rounded text-sm bg-white focus:ring-1 focus:ring-[#004488]">
                                <option value="rw">Section: Reading & Writing</option>
                                <option value="math">Section: Math</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Thời gian (phút)</label>
                            <input type="number" id="time-limit-input" class="w-full p-2 border border-slate-300 rounded text-sm font-bold text-slate-700" value="32" min="1">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Logo URL</label>
                            <input type="text" id="logo-url-input" class="w-full p-2 border border-slate-300 rounded text-sm" placeholder="URL Logo..." value="https://scontent.fhan19-1.fna.fbcdn.net/v/t39.30808-6/451857108_122097042800425386_7602682011904409290_n.png?_nc_cat=105&ccb=1-7&_nc_sid=6ee11a&_nc_eui2=AeF5KI_9YQ5D-akv4pn95ai5qZLgHr4cJYSpkuAevhwlhJcbLURmaydM6uCuaMFsO0r71uvEkcB5K3qzZJUGyQ-W&_nc_ohc=jh5DGil1sVoQ7kNvwHeq4Gy&_nc_oc=AdliAeHQtcyTo_WnU8DsNytQi6TgoV5qecCfqWz3qnP5ptMUPmnKSEyvJlDwPRJNbTI&_nc_zt=23&_nc_ht=scontent.fhan19-1.fna&_nc_gid=mWvYiwDI82jFu9mMJf0d_A&oh=00_Afg3GkZGL-wffds_Vs7bra1y1EchAvJzZwt3UCai0wrnpw&oe=692EDD83">
                        </div>
                    </div>

                    <!-- TABS -->
                    <div class="flex border-b border-slate-200 mb-4">
                        <button id="tab-content-btn" onclick="switchTab('content')" class="px-4 py-2 text-sm font-bold text-[#004488] border-b-2 border-[#004488]">Nội dung Câu hỏi</button>
                        <button id="tab-explain-btn" onclick="switchTab('explain')" class="px-4 py-2 text-sm font-bold text-slate-500 hover:text-[#004488]">Lời giải Chi tiết</button>
                    </div>

                    <!-- TAB 1: CONTENT -->
                    <div id="tab-content-panel">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 md:h-[350px] h-[500px]">
                            <div class="flex flex-col h-full min-h-0"><div class="flex justify-between items-center mb-1 shrink-0"><label class="text-[10px] font-bold text-slate-500 uppercase">Đề bài (Trái)</label><div class="flex gap-1"><button onclick="formatDoc('bold')" class="text-xs p-1 bg-white border rounded"><i class="fa-solid fa-bold"></i></button><button onclick="formatDoc('italic')" class="text-xs p-1 bg-white border rounded"><i class="fa-solid fa-italic"></i></button><button onclick="insertImage()" class="text-xs p-1 bg-white border rounded"><i class="fa-regular fa-image"></i></button></div></div><div id="q-stimulus-editor" contenteditable="true" class="editor-content w-full flex-1 min-h-0 p-3 border border-slate-300 rounded bg-white font-sat text-lg overflow-y-auto focus:ring-1 ring-blue-500 custom-scroll shrink-0" placeholder="Nhập bài đọc/đề bài..."></div></div>
                            <div class="flex flex-col h-full min-h-0"><div class="flex justify-between items-center mb-1 shrink-0"><label class="text-[10px] font-bold text-slate-500 uppercase">Câu hỏi (Phải)</label><div class="flex gap-1"><button onclick="formatDoc('bold')" class="text-xs p-1 bg-white border rounded"><i class="fa-solid fa-bold"></i></button><button onclick="formatDoc('italic')" class="text-xs p-1 bg-white border rounded"><i class="fa-solid fa-italic"></i></button></div></div><div id="q-stem-editor" contenteditable="true" class="editor-content w-full flex-1 min-h-0 p-3 border border-slate-300 rounded bg-white font-sat text-lg overflow-y-auto focus:ring-1 ring-blue-500 custom-scroll shrink-0" placeholder="Nhập câu hỏi..."></div></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Loại câu hỏi</label><select id="q-type" class="w-full p-2 border border-slate-300 rounded text-sm bg-white" onchange="toggleOptions()"><option value="mcq">Trắc nghiệm (MCQ)</option><option value="spr">Điền đáp án (SPR)</option></select></div>
                            <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Đáp án đúng</label><input type="text" id="q-correct" class="w-full p-2 border border-slate-300 rounded font-bold" placeholder="VD: A"></div>
                        </div>
                        <div id="options-container" class="space-y-2 mb-4">
                            <div class="flex items-center gap-2"><span class="font-bold w-4 text-sm text-slate-400">A</span><input type="text" id="opt-a" class="flex-1 p-2 border rounded text-sm font-sat text-lg"></div>
                            <div class="flex items-center gap-2"><span class="font-bold w-4 text-sm text-slate-400">B</span><input type="text" id="opt-b" class="flex-1 p-2 border rounded text-sm font-sat text-lg"></div>
                            <div class="flex items-center gap-2"><span class="font-bold w-4 text-sm text-slate-400">C</span><input type="text" id="opt-c" class="flex-1 p-2 border rounded text-sm font-sat text-lg"></div>
                            <div class="flex items-center gap-2"><span class="font-bold w-4 text-sm text-slate-400">D</span><input type="text" id="opt-d" class="flex-1 p-2 border rounded text-sm font-sat text-lg"></div>
                        </div>
                    </div>

                    <!-- TAB 2: EXPLANATION -->
                    <div id="tab-explain-panel" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 md:h-[400px] h-[600px]">
                            <div class="flex flex-col h-full min-h-0"><label class="text-[10px] font-bold text-slate-500 uppercase mb-1">Giải thích Bài đọc (Trái)</label><div id="expl-passage-editor" contenteditable="true" class="editor-content w-full flex-1 min-h-0 p-3 border border-slate-300 rounded bg-white font-sat text-lg overflow-y-auto focus:ring-1 ring-blue-500 custom-scroll shrink-0" placeholder="Phân tích bài đọc..."></div></div>
                            <div class="flex flex-col h-full min-h-0"><label class="text-[10px] font-bold text-slate-500 uppercase mb-1">Giải thích Đáp án (Phải)</label><div id="expl-answer-editor" contenteditable="true" class="editor-content w-full flex-1 min-h-0 p-3 border border-slate-300 rounded bg-white font-sat text-lg overflow-y-auto focus:ring-1 ring-blue-500 custom-scroll shrink-0" placeholder="Giải thích đáp án..."></div></div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-2">
                        <button id="btn-save-question" onclick="saveQuestion()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-2.5 rounded font-bold shadow-md flex justify-center items-center gap-2 transition"><i class="fa-solid fa-circle-plus"></i> Thêm vào danh sách</button>
                        <button id="btn-cancel-edit" onclick="cancelEdit()" class="hidden bg-slate-500 hover:bg-slate-600 text-white px-4 rounded font-bold shadow-md transition"><i class="fa-solid fa-xmark"></i> Hủy</button>
                    </div>
                </div>
                <div class="w-full lg:w-4/12 bg-white flex flex-col border-t lg:border-t-0">
                    <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center"><h3 class="font-bold text-slate-700 text-sm">Danh sách câu hỏi (<span id="q-count">0</span>)</h3></div>
                    <div id="question-list" class="flex-1 p-4 overflow-y-auto space-y-3 custom-scroll"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- STUDENT VIEW -->
    <div id="student-view" class="view-section bg-white font-sans h-screen flex flex-col">
        <div class="watermark-container"><img id="watermark-logo-display" src="" class="watermark-img"></div>
        <header class="h-14 brand-gradient flex items-center justify-between px-4 shrink-0 z-50 relative select-none shadow-md border-b-2 border-[#FFD700]">
            <div class="flex items-center gap-4">
                <div class="text-sm font-bold text-white flex items-center gap-2" id="header-section-name">Section 1: Reading and Writing</div>
                <button onclick="toggleDirections()" class="text-sm font-bold text-blue-100 flex items-center gap-1 hover:text-white transition">Directions <i class="fa-solid fa-chevron-down text-xs"></i></button>
                <div id="directions-dropdown" class="directions-box text-slate-800"><h4 class="font-bold mb-2">Test Directions</h4><p>The questions in this section address a number of important reading and writing skills...</p></div>
            </div>
            <div class="absolute left-1/2 transform -translate-x-1/2 top-2 text-center">
                <div class="text-lg font-mono font-bold text-white leading-none" id="timer">32:00</div>
                <div class="text-[9px] text-blue-200 font-bold cursor-pointer mt-0.5 hover:text-white transition" onclick="toggleTimer()" id="timer-btn">Hide</div>
            </div>
            <div class="flex items-center gap-4 text-blue-100">
                <div class="flex flex-col items-center cursor-pointer group hover:text-white" onclick="toggleAnnotate()" id="annotate-btn"><i class="fa-solid fa-pen text-lg group-hover:scale-110 transition"></i><span class="text-[9px] font-bold">Annotate</span></div>
                <div class="flex flex-col items-center cursor-pointer group hover:text-white" onclick="toggleTool('calculator-modal')"><i class="fa-solid fa-calculator text-lg group-hover:scale-110 transition"></i><span class="text-[9px] font-bold">Calculator</span></div>
                <div class="flex flex-col items-center cursor-pointer group hover:text-white" onclick="toggleTool('ref-sheet-modal')"><i class="fa-solid fa-shapes text-lg group-hover:scale-110 transition"></i><span class="text-[9px] font-bold">Reference</span></div>
                <div class="flex flex-col items-center cursor-pointer group hover:text-white"><i class="fa-solid fa-ellipsis-vertical text-lg group-hover:scale-110 transition"></i><span class="text-[9px] font-bold">More</span></div>
            </div>
            <div class="absolute bottom-0 left-0 w-full bluebook-dash"></div>
        </header>

        <main class="flex-1 flex overflow-hidden relative z-10" id="main-content">
            <div class="w-1/2 border-r border-slate-300 h-full flex flex-col bg-white" id="stimulus-pane">
                <div class="flex-1 overflow-y-auto p-5 flex flex-col">
                    <div id="stimulus-area" class="student-content font-sat text-slate-900"></div>
                    <div id="expl-passage-box" class="hidden mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded text-sm font-sat text-slate-800 animate-slideUp">
                        <div class="font-bold text-yellow-700 mb-2 uppercase text-xs tracking-wide">Phân tích bài đọc</div><div id="expl-passage-content"></div>
                    </div>
                </div>
            </div>
            <div class="w-1/2 h-full flex flex-col bg-white" id="question-pane">
                <div class="flex-1 overflow-y-auto p-5 pt-4">
                    <div class="max-w-xl mx-auto fade-in" id="question-container">
                        <div class="flex justify-between items-start mb-3 bg-gray-100 rounded p-1">
                            <div class="flex items-center"><div class="bg-black text-white text-sm font-bold w-7 h-7 flex items-center justify-center mr-2 rounded"><span id="q-number-disp">1</span></div><button onclick="toggleMark()" id="mark-btn" class="flex items-center gap-2 text-slate-700 font-bold text-xs"><i class="fa-regular fa-bookmark text-base"></i><span>Mark for Review</span></button></div>
                            <div class="text-xs font-bold border border-black px-1 rounded bg-white text-gray-500 line-through decoration-black">ABC</div>
                        </div>
                        <div id="question-text-area" class="student-content font-sat text-slate-900 mb-4"></div>
                        <div id="interaction-area" class="pb-4"></div>
                        <div id="expl-answer-box" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded text-sm font-sat text-slate-800 animate-slideUp">
                            <div class="font-bold text-green-700 mb-2 uppercase text-xs tracking-wide">Giải thích đáp án</div><div id="expl-answer-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="h-16 border-t border-slate-200 bg-white grid grid-cols-3 items-center px-6 shrink-0 select-none z-50 relative shadow-md">
            <div class="flex items-center gap-3 justify-start">
                <div class="w-10 h-10 rounded-full border-2 border-slate-100 overflow-hidden bg-white shadow-sm flex-shrink-0"><img id="footer-logo-img" src="" class="w-full h-full object-cover"></div>
                <span class="font-bold text-slate-700 text-sm hidden md:block whitespace-nowrap">SAT Thủ Khoa Đức An</span>
            </div>
            <div class="flex justify-center"><button onclick="toggleNavigator()" class="bg-slate-900 text-white font-bold text-sm px-4 py-1.5 rounded flex items-center gap-2 hover:bg-slate-700 transition shadow-sm">Question <span id="footer-q-curr">1</span> of <span id="footer-q-total">10</span> <i class="fa-solid fa-chevron-up text-xs"></i></button></div>
            <div class="flex items-center gap-3 justify-end">
                 <button id="btn-prev" onclick="handlePrev()" class="bg-[#004488] hover:bg-[#003366] disabled:opacity-50 text-white px-6 py-2.5 rounded-lg font-bold text-sm shadow-md transition transform active:scale-95">Back</button>
                 <button id="btn-next" onclick="handleNext()" class="bg-[#004488] hover:bg-[#003366] disabled:opacity-50 text-white px-6 py-2.5 rounded-lg font-bold text-sm shadow-md transition transform active:scale-95">Next</button>
            </div>
        </footer>

        <div id="navigator-modal" class="nav-modal"><div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="font-bold text-lg">Question Navigator</h3><button onclick="toggleNavigator()"><i class="fa-solid fa-xmark"></i></button></div><div class="nav-grid" id="nav-grid-content"></div><div class="mt-4 pt-3 border-t flex gap-6 text-xs justify-center"><div class="flex items-center gap-2"><div class="w-3 h-3 border-2 border-dashed border-[#004488]"></div> Current</div><div class="flex items-center gap-2"><div class="w-3 h-3 bg-[#004488]"></div> Answered</div><div class="flex items-center gap-2"><div class="w-3 h-3 border border-slate-300"></div> Unanswered</div><div class="flex items-center gap-2"><i class="fa-solid fa-bookmark text-red-600"></i> For Review</div></div></div>
        <div id="calculator-modal" class="tool-modal" style="width: 700px; height: 550px;"><div class="tool-header" id="calc-header"><span class="flex items-center gap-2"><i class="fa-solid fa-calculator text-[#004488]"></i> Desmos Graphing Calculator</span><button onclick="toggleTool('calculator-modal')" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-lg"></i></button></div><div id="desmos-calculator" style="width:100%;height:calc(100% - 40px);"></div></div>
        <div id="ref-sheet-modal" class="tool-modal" style="width: 650px; height: 500px;"><div class="tool-header" id="ref-header"><span class="flex items-center gap-2"><i class="fa-solid fa-shapes text-[#004488]"></i> Reference Sheet</span><button onclick="toggleTool('ref-sheet-modal')" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-lg"></i></button></div><div class="p-8 h-full overflow-y-auto text-sm text-slate-700 bg-white font-sat"><h4 class="font-bold border-b pb-2 mb-4 text-xs uppercase tracking-wide text-slate-400 font-sans">Common Formulas</h4><div class="grid grid-cols-2 gap-6"><div class="bg-slate-50 p-4 rounded-xl border border-slate-100 flex flex-col items-center"><div class="text-lg mb-2">$A = \pi r^2$</div><div class="text-xs font-sans text-slate-500 font-bold uppercase">Area of Circle</div></div><div class="bg-slate-50 p-4 rounded-xl border border-slate-100 flex flex-col items-center"><div class="text-lg mb-2">$a^2 + b^2 = c^2$</div><div class="text-xs font-sans text-slate-500 font-bold uppercase">Pythagorean Theorem</div></div></div></div></div>
    </div>

    <div id="review-page" class="view-section bg-slate-50 p-8 overflow-y-auto font-sans">
        <div class="max-w-4xl mx-auto bg-white rounded shadow-lg overflow-hidden h-[90vh] flex flex-col"><div class="p-6 border-b"><h1 class="text-2xl font-bold">Review</h1></div><div class="flex-1 overflow-y-auto"><table class="w-full review-table"><tbody id="review-list-body"></tbody></table></div><div class="p-6 border-t flex justify-end"><button onclick="submitExam()" class="bg-[#004488] text-white px-6 py-2 rounded font-bold">Submit</button></div></div>
    </div>
    <div id="results-page" class="view-section bg-slate-50 p-8 font-sans text-center"><h1 class="text-4xl font-bold mb-4">Score: <span id="score-display">--</span></h1><button onclick="location.reload()" class="bg-black text-white px-6 py-2 rounded">Exit</button></div>

    <script>
        let questions=[], currentQIndex=0, userAnswers={}, userAnnotations={}, markedQuestions=new Set();
        let timerInterval, timeLeft=32*60, isTimerHidden=false, isAnnotateMode=false, isReviewMode=false;
        let editingIndex = -1; 

        window.onload = function() { loadFromStorage(); var elt = document.getElementById('desmos-calculator'); Desmos.GraphingCalculator(elt, { keypad: true, expressions: true, settingsMenu: true, border: false }); makeDraggable(document.getElementById('calculator-modal'), document.getElementById('calc-header')); makeDraggable(document.getElementById('ref-sheet-modal'), document.getElementById('ref-header')); document.addEventListener('mouseup', handleTextSelection); document.addEventListener('keydown', handleShortcuts); };
        
        function handleNext() {
            try {
                saveCurrentAnnotations();
                if (currentQIndex < questions.length - 1) {
                    loadQuestion(currentQIndex + 1);
                } else if (!isReviewMode) {
                    goToReviewPage();
                } else {
                    switchView('results-page'); 
                }
            } catch(e) { console.error(e); }
        }
        function handlePrev() { try { saveCurrentAnnotations(); if (currentQIndex > 0) loadQuestion(currentQIndex - 1); } catch(e) { console.error(e); } }
        function handleShortcuts(e) { if(document.body.classList.contains('mode-teacher')) return; if(e.key === 'ArrowRight') handleNext(); if(e.key === 'ArrowLeft') handlePrev(); }
        
        function switchTab(t) { document.getElementById('tab-content-panel').classList.toggle('hidden', t !== 'content'); document.getElementById('tab-explain-panel').classList.toggle('hidden', t !== 'explain'); document.getElementById('tab-content-btn').className = t==='content' ? "px-4 py-2 text-sm font-bold text-[#004488] border-b-2 border-[#004488]" : "px-4 py-2 text-sm font-bold text-slate-500 hover:text-[#004488]"; document.getElementById('tab-explain-btn').className = t==='explain' ? "px-4 py-2 text-sm font-bold text-[#004488] border-b-2 border-[#004488]" : "px-4 py-2 text-sm font-bold text-slate-500 hover:text-[#004488]"; }
        
        function saveQuestion() {
            const s1=document.getElementById('q-stimulus-editor').innerHTML, s2=document.getElementById('q-stem-editor').innerHTML, c=document.getElementById('q-correct').value;
            const e1=document.getElementById('expl-passage-editor').innerHTML, e2=document.getElementById('expl-answer-editor').innerHTML;
            if(!s2.trim() && !s1.trim()) return alert("Nhập nội dung!");
            
            const qObj = { 
                id: (editingIndex !== -1) ? questions[editingIndex].id : Date.now(), 
                stimulus:s1, stem:s2, type:document.getElementById('q-type').value, correct:c, explPassage:e1, explAnswer:e2, 
                options:{A:document.getElementById('opt-a').value, B:document.getElementById('opt-b').value, C:document.getElementById('opt-c').value, D:document.getElementById('opt-d').value}
            };

            if(editingIndex !== -1) { questions[editingIndex] = qObj; cancelEdit(); } else { questions.push(qObj); resetForm(); }
            saveToStorage(); renderQuestionList();
        }

        function editQuestion(index) {
            const q = questions[index]; editingIndex = index;
            document.getElementById('q-stimulus-editor').innerHTML = q.stimulus || ""; document.getElementById('q-stem-editor').innerHTML = q.stem || "";
            document.getElementById('q-type').value = q.type; document.getElementById('q-correct').value = q.correct;
            document.getElementById('opt-a').value = q.options.A; document.getElementById('opt-b').value = q.options.B;
            document.getElementById('opt-c').value = q.options.C; document.getElementById('opt-d').value = q.options.D;
            document.getElementById('expl-passage-editor').innerHTML = q.explPassage || ""; document.getElementById('expl-answer-editor').innerHTML = q.explAnswer || "";
            toggleOptions(); switchTab('content');
            const btnSave = document.getElementById('btn-save-question'); btnSave.innerHTML = '<i class="fa-solid fa-rotate"></i> Lưu thay đổi'; btnSave.className = "flex-1 bg-orange-500 hover:bg-orange-600 text-white py-2.5 rounded font-bold shadow-md flex justify-center items-center gap-2 transition";
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
        }

        function cancelEdit() {
            editingIndex = -1; resetForm();
            const btnSave = document.getElementById('btn-save-question'); btnSave.innerHTML = '<i class="fa-solid fa-circle-plus"></i> Thêm vào danh sách'; btnSave.className = "flex-1 bg-emerald-600 hover:bg-emerald-700 text-white py-2.5 rounded font-bold shadow-md flex justify-center items-center gap-2 transition";
            document.getElementById('btn-cancel-edit').classList.add('hidden');
        }

        function resetForm() {
            document.getElementById('q-stimulus-editor').innerHTML=''; document.getElementById('q-stem-editor').innerHTML=''; 
            document.getElementById('q-correct').value=''; document.getElementById('expl-passage-editor').innerHTML=''; 
            document.getElementById('expl-answer-editor').innerHTML=''; ['a','b','c','d'].forEach(k=>document.getElementById('opt-'+k).value='');
            switchTab('content');
        }

        function renderQuestionList(){
            const l=document.getElementById('question-list');l.innerHTML='';document.getElementById('q-count').innerText=questions.length;
            questions.forEach((q,i)=>{
                const isActive = (i === editingIndex) ? "border-orange-400 bg-orange-50 ring-1 ring-orange-400" : "border-slate-200 bg-white hover:border-blue-500";
                l.innerHTML+=`<div class="p-3 border rounded mb-2 text-sm relative group ${isActive}"><div class="font-bold text-blue-800">Q${i+1}</div><div class="text-gray-500 text-xs">${(q.stem||"").replace(/<[^>]*>/g,'').substring(0,50)}...</div><div class="absolute top-2 right-2 flex gap-2"><button onclick="editQuestion(${i})" class="text-blue-400 hover:text-blue-600"><i class="fa-solid fa-pen"></i></button><button onclick="deleteQ(${i})" class="text-red-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div></div>`
            })
        }

        // ... Standard functions ...
        function saveToStorage(){localStorage.setItem('sat_data_v3',JSON.stringify(questions))}
        function loadFromStorage(){try{questions=JSON.parse(localStorage.getItem('sat_data_v3')||'[]');renderQuestionList()}catch(e){}}
        function clearAllData(){if(confirm("Delete?")){questions=[];saveToStorage();renderQuestionList()}}
        function exportData(){const d="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(questions));const a=document.createElement('a');a.href=d;a.download="sat.json";document.body.appendChild(a);a.click();a.remove()}
        function importData(i){const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=(e)=>{try{questions=JSON.parse(e.target.result);saveToStorage();renderQuestionList();alert("Done")}catch{alert("Err")}};r.readAsText(f)}
        function formatDoc(c) { document.execCommand(c, false, null); }
        function insertImage() { const u = prompt("URL:"); if(u) document.execCommand('insertImage', false, u); }
        function deleteQ(i){if(confirm("Del?")){questions.splice(i,1); if(editingIndex===i) cancelEdit(); saveToStorage();renderQuestionList()}}
        function toggleOptions(){document.getElementById('options-container').style.display=document.getElementById('q-type').value==='mcq'?'block':'none'}
        function startTest(){if(questions.length===0)return alert("Empty!");document.getElementById('header-section-name').innerText=document.getElementById('section-config').value==='math'?"Section 1: Math":"Section 1: Reading & Writing";const l=document.getElementById('logo-url-input').value;if(l){document.getElementById('watermark-logo-display').src=l;document.getElementById('footer-logo-img').src=l}userAnswers={};markedQuestions.clear();currentQIndex=0; 
            const tInput = document.getElementById('time-limit-input'); timeLeft = (tInput && tInput.value) ? parseInt(tInput.value)*60 : 32*60;
            isReviewMode=false;document.body.classList.remove('mode-teacher');switchView('student-view');document.getElementById('footer-q-total').innerText=questions.length;startTimer();renderQuestionContent(0)}
        function switchView(id){document.querySelectorAll('.view-section').forEach(el=>el.classList.remove('view-active'));document.getElementById(id).classList.add('view-active')}
        function loadQuestion(i){if(i<0||i>=questions.length)return;currentQIndex=i;renderQuestionContent(i)}
        
        function renderQuestionContent(i) {
            const q = questions[i];
            const btn = document.getElementById('btn-next'); 
            btn.innerText = (i === questions.length-1) ? (isReviewMode ? "Finish Review" : "Next (End)") : "Next";
            document.getElementById('btn-prev').disabled = (i===0);
            
            document.getElementById('q-number-disp').innerText = i+1; document.getElementById('footer-q-curr').innerText = i+1;
            const s1=document.getElementById('stimulus-area'), s2=document.getElementById('question-text-area');
            if(q.stimulus!==undefined){s1.innerHTML=q.stimulus;s2.innerHTML=q.stem;}else{s1.innerHTML=q.text||"";s2.innerHTML="";}
            const mb=document.getElementById('mark-btn');
            if(markedQuestions.has(q.id)) mb.innerHTML='<i class="fa-solid fa-bookmark text-lg text-red-600"></i><span class="text-red-600">Marked</span>'; else mb.innerHTML='<i class="fa-regular fa-bookmark text-lg"></i><span>Mark for Review</span>';
            const area=document.getElementById('interaction-area'); let html=''; const u=userAnswers[q.id];
            if(q.type==='mcq'){ ['A','B','C','D'].forEach(opt=>{ if(!q.options[opt])return; let c="sat-option"; if(isReviewMode){ if(opt===q.correct.toUpperCase())c+=" correct-answer"; else if(u===opt)c+=" wrong-answer"; } else if(u===opt)c+=" selected"; html+=`<div class="${c}" onclick="${isReviewMode?'':`selectOption('${opt}', this)`}" id="opt-row-${opt}"><div class="sat-circle">${opt}</div><div class="flex-1 pt-0.5 font-sat text-[1.05rem] text-black">${q.options[opt]}</div></div>`; }); } else { html+=`<div class="mt-4 p-4 border rounded"><input type="text" value="${u||''}" ${isReviewMode?'readonly':''} oninput="saveSPR(this.value)" class="w-full p-2 text-xl font-mono border rounded" placeholder="Answer..."></div>`; }
            area.innerHTML=html;
            const expL=document.getElementById('expl-passage-box'), expR=document.getElementById('expl-answer-box');
            if(isReviewMode){ if(q.explPassage){expL.classList.remove('hidden');document.getElementById('expl-passage-content').innerHTML=q.explPassage;}else{expL.classList.add('hidden');} if(q.explAnswer){expR.classList.remove('hidden');document.getElementById('expl-answer-content').innerHTML=q.explAnswer;}else{expR.classList.add('hidden');} } else { expL.classList.add('hidden'); expR.classList.add('hidden'); }
            const cont=document.getElementById('question-container'); cont.classList.remove('fade-in'); void cont.offsetWidth; cont.classList.add('fade-in'); refreshMathJax();
        }
        function selectOption(o,el){userAnswers[questions[currentQIndex].id]=o;if(el){document.querySelectorAll('.sat-option').forEach(d=>d.classList.remove('selected'));el.classList.add('selected')}}
        function saveSPR(v){userAnswers[questions[currentQIndex].id]=v}
        function toggleMark(){const id=questions[currentQIndex].id;if(markedQuestions.has(id))markedQuestions.delete(id);else markedQuestions.add(id);renderQuestionContent(currentQIndex)}
        function toggleNavigator(){const m=document.getElementById('navigator-modal');m.style.display=m.style.display==='block'?'none':'block';if(m.style.display==='block'){const g=document.getElementById('nav-grid-content');g.innerHTML='';questions.forEach((q,i)=>{let c='nav-item';if(i===currentQIndex)c+=' current';if(userAnswers[q.id])c+=' answered';g.innerHTML+=`<div class="${c}" onclick="loadQuestion(${i});toggleNavigator()">${i+1}${markedQuestions.has(q.id)?'<div class="nav-flag"></div>':''}</div>`})}}
        function submitExam(){isReviewMode=true;let s=0;questions.forEach(q=>{if((userAnswers[q.id]||"").trim().toUpperCase()===q.correct.trim().toUpperCase())s++});document.getElementById('score-display').innerText=Math.round((s/questions.length)*100)+"%";switchView('results-page')}
        function goToReviewPage(){saveCurrentAnnotations();switchView('review-page');renderReviewTable()}
        function renderReviewTable(){const b=document.getElementById('review-list-body');b.innerHTML='';questions.forEach((q,i)=>{b.innerHTML+=`<tr class="border-b"><td class="p-3 text-center">${i+1}</td><td class="p-3">${userAnswers[q.id]?'Answered':'Unanswered'}</td><td class="p-3 text-center">${markedQuestions.has(q.id)?'Marked':''}</td></tr>`})}
        function toggleAnnotate(){isAnnotateMode=!isAnnotateMode;document.body.classList.toggle('cursor-text',isAnnotateMode)}
        function handleTextSelection(){if(!isAnnotateMode)return;const s=window.getSelection();if(s.toString().length>0){document.designMode="on";document.execCommand("hiliteColor",false,"#fef08a");document.designMode="off";s.removeAllRanges()}}
        function toggleDirections(){const d=document.getElementById('directions-dropdown');d.style.display=d.style.display==='block'?'none':'block'}
        function toggleTimer(){isTimerHidden=!isTimerHidden;document.getElementById('timer').style.opacity=isTimerHidden?'0':'1';document.getElementById('timer-btn').innerText=isTimerHidden?'Show':'Hide'}
        function toggleTool(id){const e=document.getElementById(id);e.style.display=e.style.display==='block'?'none':'block'}
        function refreshMathJax(){if(window.MathJax)MathJax.typesetPromise().catch(()=>{})}
        function startTimer(){clearInterval(timerInterval);timerInterval=setInterval(()=>{if(timeLeft<=0){clearInterval(timerInterval);alert("End!");submitExam();return;}timeLeft--;const m=Math.floor(timeLeft/60),s=timeLeft%60;document.getElementById('timer').innerText=`${m}:${s<10?'0':''}${s}`},1000)}
        function makeDraggable(elm,head){let pos1=0,pos2=0,pos3=0,pos4=0;head.onmousedown=(e)=>{e.preventDefault();pos3=e.clientX;pos4=e.clientY;document.onmouseup=closeDrag;document.onmousemove=drag};function drag(e){e.preventDefault();pos1=pos3-e.clientX;pos2=pos4-e.clientY;pos3=e.clientX;pos4=e.clientY;elm.style.top=(elm.offsetTop-pos2)+"px";elm.style.left=(elm.offsetLeft-pos1)+"px"}function closeDrag(){document.onmouseup=null;document.onmousemove=null}}
        function saveCurrentAnnotations() { if(questions.length===0) return; const id=questions[currentQIndex].id; const s=document.getElementById('stimulus-area'), q=document.getElementById('question-text-area'); if(s && q) userAnnotations[id]={stimulus:s.innerHTML,question:q.innerHTML}; }
    </script>
</body>
</html>
